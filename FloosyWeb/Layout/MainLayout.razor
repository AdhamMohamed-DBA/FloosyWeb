@inherits LayoutComponentBase
@inject NavigationManager Nav
@inject FirebaseService Firebase
@inject IJSRuntime JS
@inject LocalizationService L

<div class="page-shell" dir="@(L.IsArabic ? "rtl" : "ltr")" lang="@(L.IsArabic ? "ar" : "en")">
    <main class="page-content">
        @Body
    </main>
</div>

@if (isUpdateNoticeVisible)
{
    <AppModal Visible="@isUpdateNoticeVisible" Title="@L.T("AppUpdated")">
        <ChildContent>
            <p style="color:#bbb; font-size:12px; margin-top:0;">@L.T("Version"): <b>@activeUpdateVersion</b></p>
            <p style="color:#fff; white-space:pre-wrap; text-align:@activeUpdateTextAlign;" dir="@activeUpdateDir">@activeUpdateMessage</p>
        </ChildContent>
        <FooterContent>
            <AppButton Text="@L.T("Ok")"
                       Style="width:100%;"
                       OnClick="@(async _ => await AcknowledgeUpdateNotice())" />
        </FooterContent>
    </AppModal>
}

@if (isUpdateRequiredVisible)
{
    <AppModal Visible="@isUpdateRequiredVisible" Title="@L.T("UpdateRequired")" Style="border:1px solid #e67e22;">
        <ChildContent>
            <p style="color:#ccc; margin-bottom:8px;">@L.T("CurrentVersionText"): <b>@CurrentAppVersion</b></p>
            <p style="color:#ccc; margin-bottom:8px;">@L.T("LatestVersionText"): <b>@requiredLatestVersion</b></p>
            <p style="color:#fff; white-space:pre-wrap; margin-bottom:0; text-align:@requiredUpdateTextAlign;" dir="@requiredUpdateDir">@requiredUpdateMessage</p>
        </ChildContent>
        <FooterContent>
            <div style="display:flex; gap:10px;">
                <AppButton Text="@L.T("UpdateNow")"
                           Style="flex:1; background:#00E676; color:black;"
                           OnClick="@(async _ => await UpdateNowAsync())" />
                <AppButton Text="@L.T("Ok")"
                           Variant="ghost"
                           Style="flex:1; background:#333; color:white;"
                           OnClick="@(_ => { isUpdateRequiredVisible = false; return Task.CompletedTask; })" />
            </div>
        </FooterContent>
    </AppModal>
}

@if (!string.IsNullOrEmpty(Firebase.CurrentUserId) && !Nav.Uri.EndsWith("/") && !Nav.Uri.Contains("/login"))
{
    <div class="bottom-nav">
        <a href="home" class="nav-item @(IsActive("home") ? "active" : "")" aria-current="@(IsActive("home") ? "page" : null)" aria-label="Go to Home page">
            <img src="images/home.png" class="nav-icon" />
            <span>@L.T("Home")</span>
        </a>
        <a href="bills" class="nav-item @(IsActive("bills") ? "active" : "")" aria-current="@(IsActive("bills") ? "page" : null)" aria-label="Go to Bills page">
            <img src="images/bill.png" class="nav-icon" />
            <span>@L.T("Bills")</span>
        </a>
        <a href="charts" class="nav-item @(IsActive("charts") ? "active" : "")" aria-current="@(IsActive("charts") ? "page" : null)" aria-label="Go to Charts page">
            <img src="images/chart.png" class="nav-icon" />
            <span>@L.T("Charts")</span>
        </a>
        <a href="debts" class="nav-item @(IsActive("debts") ? "active" : "")" aria-current="@(IsActive("debts") ? "page" : null)" aria-label="Go to Debts page">
            <img src="images/bill.png" class="nav-icon" />
            <span>@L.T("Debts")</span>
        </a>
        <a href="history" class="nav-item @(IsActive("history") ? "active" : "")" aria-current="@(IsActive("history") ? "page" : null)" aria-label="Go to History page">
            <img src="images/history.png" class="nav-icon" />
            <span>@L.T("History")</span>
        </a>
        <a href="settings" class="nav-item @(IsActive("settings") ? "active" : "")" aria-current="@(IsActive("settings") ? "page" : null)" aria-label="Go to Settings page">
            <img src="images/setting.png" class="nav-icon" />
            <span>@L.T("Settings")</span>
        </a>
    </div>
}

@code {
    private const string CurrentAppVersion = "2.5.0";

    bool isUpdateNoticeVisible = false;
    bool isUpdateRequiredVisible = false;
    string activeUpdateVersion = "";
    string activeUpdateMessage = "";
    string activeUpdateDir = "ltr";
    string activeUpdateTextAlign = "left";
    string requiredLatestVersion = "";
    string requiredUpdateMessage = "";
    string requiredUpdateDir = "ltr";
    string requiredUpdateTextAlign = "left";

    bool IsActive(string href)
    {
        var relative = Nav.ToBaseRelativePath(Nav.Uri).ToLowerInvariant();
        return relative == href || relative.StartsWith(href + "/");
    }

    protected override void OnInitialized()
    {
        // ðŸ”¥ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¯ÙŠ Ù‡Ù†Ø§ Ø¢Ù…Ù† Ø¹Ø´Ø§Ù† Ø§Ù„Ù€ JS Ø¨ÙŠÙƒÙˆÙ† Ø­Ù…Ù„
        Firebase.InitUser();
        L.Init();
        L.OnChange += HandleLocalizationChanged;
        Nav.LocationChanged += (s, e) => StateHasChanged();
    }

    void HandleLocalizationChanged() => InvokeAsync(StateHasChanged);

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;
        await EvaluateUpdateStateAsync();
    }

    async Task EvaluateUpdateStateAsync()
    {
        if (string.IsNullOrEmpty(Firebase.CurrentUserId)) return;

        var update = await Firebase.LoadUpdateBroadcast();
        if (!update.IsRequired) return;
        if (string.IsNullOrWhiteSpace(update.Version) || string.IsNullOrWhiteSpace(update.Message)) return;

        var latestVersion = (update.Version ?? string.Empty).Trim();
        var requiredVersion = string.IsNullOrWhiteSpace(update.RequiredVersion)
            ? latestVersion
            : update.RequiredVersion.Trim();

        var versionComparison = CompareVersions(CurrentAppVersion, requiredVersion);

        // User version is older than required version => show update-required prompt every app open
        if (versionComparison < 0)
        {
            requiredLatestVersion = requiredVersion;
            requiredUpdateMessage = update.Message;

            var reqAlignment = (update.MessageAlignment ?? "ltr").Trim().ToLowerInvariant();
            requiredUpdateDir = reqAlignment == "rtl" ? "rtl" : "ltr";
            requiredUpdateTextAlign = reqAlignment == "rtl" ? "right" : "left";

            isUpdateRequiredVisible = true;
            isUpdateNoticeVisible = false;
            await InvokeAsync(StateHasChanged);
            return;
        }

        var key = $"floosy_seen_update_{Firebase.CurrentUserId}";
        var seenVersion = await JS.InvokeAsync<string>("localStorage.getItem", key);
        if (string.Equals(seenVersion, latestVersion, StringComparison.OrdinalIgnoreCase)) return;

        activeUpdateVersion = latestVersion;
        activeUpdateMessage = update.Message;
        var alignment = (update.MessageAlignment ?? "ltr").Trim().ToLowerInvariant();
        activeUpdateDir = alignment == "rtl" ? "rtl" : "ltr";
        activeUpdateTextAlign = alignment == "rtl" ? "right" : "left";
        isUpdateNoticeVisible = true;
        isUpdateRequiredVisible = false;
        await InvokeAsync(StateHasChanged);
    }

    async Task AcknowledgeUpdateNotice()
    {
        if (!string.IsNullOrEmpty(Firebase.CurrentUserId) && !string.IsNullOrWhiteSpace(activeUpdateVersion))
        {
            var key = $"floosy_seen_update_{Firebase.CurrentUserId}";
            await JS.InvokeVoidAsync("localStorage.setItem", key, activeUpdateVersion);
        }

        isUpdateNoticeVisible = false;
    }

    async Task UpdateNowAsync()
    {
        try
        {
            await JS.InvokeVoidAsync("floosyAppUpdateNow");
        }
        catch
        {
            Nav.NavigateTo(Nav.Uri, forceLoad: true);
        }
    }

    static int CompareVersions(string current, string target)
    {
        var a = (current ?? string.Empty).Split('.', StringSplitOptions.RemoveEmptyEntries);
        var b = (target ?? string.Empty).Split('.', StringSplitOptions.RemoveEmptyEntries);
        var max = Math.Max(a.Length, b.Length);

        for (int i = 0; i < max; i++)
        {
            var left = (i < a.Length && int.TryParse(a[i], out var av)) ? av : 0;
            var right = (i < b.Length && int.TryParse(b[i], out var bv)) ? bv : 0;

            if (left < right) return -1;
            if (left > right) return 1;
        }

        return 0;
    }

    public void Dispose()
    {
        L.OnChange -= HandleLocalizationChanged;
    }
}