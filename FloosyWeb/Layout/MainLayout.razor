@inherits LayoutComponentBase
@inject NavigationManager Nav
@inject FirebaseService Firebase
@inject IJSRuntime JS

<div class="page-shell">
    <main class="page-content">
        @Body
    </main>
</div>

@if (isUpdateNoticeVisible)
{
    <AppModal Visible="@isUpdateNoticeVisible" Title="App Updated">
        <ChildContent>
            <p style="color:#bbb; font-size:12px; margin-top:0;">Version: <b>@activeUpdateVersion</b></p>
            <p style="color:#fff; white-space:pre-wrap;">@activeUpdateMessage</p>
        </ChildContent>
        <FooterContent>
            <AppButton Text="OK"
                       Style="width:100%;"
                       OnClick="@(async _ => await AcknowledgeUpdateNotice())" />
        </FooterContent>
    </AppModal>
}

@if (!string.IsNullOrEmpty(Firebase.CurrentUserId) && !Nav.Uri.EndsWith("/") && !Nav.Uri.Contains("/login"))
{
    <div class="bottom-nav">
        <a href="home" class="nav-item @(IsActive("home") ? "active" : "")" aria-current="@(IsActive("home") ? "page" : null)" aria-label="Go to Home page">
            <img src="images/home.png" class="nav-icon" />
            <span>Home</span>
        </a>
        <a href="bills" class="nav-item @(IsActive("bills") ? "active" : "")" aria-current="@(IsActive("bills") ? "page" : null)" aria-label="Go to Bills page">
            <img src="images/bill.png" class="nav-icon" />
            <span>Bills</span>
        </a>
        <a href="charts" class="nav-item @(IsActive("charts") ? "active" : "")" aria-current="@(IsActive("charts") ? "page" : null)" aria-label="Go to Charts page">
            <img src="images/chart.png" class="nav-icon" />
            <span>Charts</span>
        </a>
        <a href="debts" class="nav-item @(IsActive("debts") ? "active" : "")" aria-current="@(IsActive("debts") ? "page" : null)" aria-label="Go to Debts page">
            <img src="images/bill.png" class="nav-icon" />
            <span>Debts</span>
        </a>
        <a href="history" class="nav-item @(IsActive("history") ? "active" : "")" aria-current="@(IsActive("history") ? "page" : null)" aria-label="Go to History page">
            <img src="images/history.png" class="nav-icon" />
            <span>History</span>
        </a>
        <a href="settings" class="nav-item @(IsActive("settings") ? "active" : "")" aria-current="@(IsActive("settings") ? "page" : null)" aria-label="Go to Settings page">
            <img src="images/setting.png" class="nav-icon" />
            <span>Settings</span>
        </a>
    </div>
}

@code {
    bool isUpdateNoticeVisible = false;
    string activeUpdateVersion = "";
    string activeUpdateMessage = "";

    bool IsActive(string href)
    {
        var relative = Nav.ToBaseRelativePath(Nav.Uri).ToLowerInvariant();
        return relative == href || relative.StartsWith(href + "/");
    }

    protected override void OnInitialized()
    {
        // ðŸ”¥ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¯ÙŠ Ù‡Ù†Ø§ Ø¢Ù…Ù† Ø¹Ø´Ø§Ù† Ø§Ù„Ù€ JS Ø¨ÙŠÙƒÙˆÙ† Ø­Ù…Ù„
        Firebase.InitUser();
        Nav.LocationChanged += (s, e) => StateHasChanged();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;
        await TryShowUpdateNoticeAsync();
    }

    async Task TryShowUpdateNoticeAsync()
    {
        if (string.IsNullOrEmpty(Firebase.CurrentUserId)) return;

        var update = await Firebase.LoadUpdateBroadcast();
        if (!update.IsRequired) return;
        if (string.IsNullOrWhiteSpace(update.Version) || string.IsNullOrWhiteSpace(update.Message)) return;

        var key = $"floosy_seen_update_{Firebase.CurrentUserId}";
        var seenVersion = await JS.InvokeAsync<string>("localStorage.getItem", key);
        if (string.Equals(seenVersion, update.Version, StringComparison.OrdinalIgnoreCase)) return;

        activeUpdateVersion = update.Version;
        activeUpdateMessage = update.Message;
        isUpdateNoticeVisible = true;
        await InvokeAsync(StateHasChanged);
    }

    async Task AcknowledgeUpdateNotice()
    {
        if (!string.IsNullOrEmpty(Firebase.CurrentUserId) && !string.IsNullOrWhiteSpace(activeUpdateVersion))
        {
            var key = $"floosy_seen_update_{Firebase.CurrentUserId}";
            await JS.InvokeVoidAsync("localStorage.setItem", key, activeUpdateVersion);
        }

        isUpdateNoticeVisible = false;
    }
}