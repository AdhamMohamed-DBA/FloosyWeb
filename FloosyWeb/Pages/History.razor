@page "/history"
@using FloosyWeb.Models
@inject FirebaseService Firebase
@inject IJSRuntime JS

<div class="page-section" style="padding-bottom:88px;">

    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h3 style="margin:0;">History 📜</h3>
    </div>

    <div class="card" style="padding:15px; margin-bottom:20px; background:#1f1f1f;">
        <label style="color:gray; font-size:12px;">Filter by Month</label>
        <input type="month"
               value="@selectedMonthStr"
               @onchange="@(e => selectedMonthStr = e.Value?.ToString() ?? "")"
               class="input-dark"
               style="margin-bottom:0;" />
    </div>

    @if (!FilteredTransactions.Any())
    {
        <div style="text-align:center; padding:30px; color:gray;">
            <p>No transactions found for this month.</p>
        </div>
    }
    else
    {
        @foreach (var t in FilteredTransactions)
        {
            <div style="background:#1f1f1f; padding:15px; border-left: 4px solid @t.ColorHex; margin-bottom:10px; border-radius:10px; display:flex; justify-content:space-between; align-items:center;">
                <div style="flex:1;">
                    <div style="color:@t.ColorHex; font-size:11px;">@t.Category</div>
                    <div style="font-weight:bold; color:white; font-size:1.1em;">@t.Desc</div>
                    <div style="color:gray; font-size:11px;">@t.Date.ToString("dd MMM, HH:mm")</div>
                </div>
                <div style="text-align:right;">
                    <div style="font-weight:bold; font-size:1.2em; color:@t.ColorHex; margin-bottom:5px;">@t.AmountDisplay</div>
                    <div style="display:flex; gap:10px; justify-content:flex-end;">
                        <button class="icon-btn" style="font-size:16px;" @onclick="() => EditTrans(t)" aria-label="Edit transaction" title="Edit transaction">✏️</button>
                        <button class="icon-btn" style="font-size:16px;" @onclick="() => ConfirmDelete(t)" aria-label="Delete transaction" title="Delete transaction">🗑️</button>
                    </div>
                </div>
            </div>
        }
    }
</div>

@if (isEditVisible)
{
    <div class="modal-backdrop">
        <div class="modal-content">
            <h3>Edit Transaction</h3>
            <input @bind="selectedTrans.Desc" class="input-dark" placeholder="Description" />
            <input type="number" @bind="selectedTrans.Amount" class="input-dark" placeholder="Amount" />

            <label style="font-size:12px; color:gray;">Update Balance on Account:</label>
            <select @bind="editAccountId" class="input-dark">
                <option value="">Don't Change Balance (Text Only)</option>
                @foreach (var acc in myData.Accounts)
                {
                    <option value="@acc.Id">@acc.Name</option>
                }
            </select>

            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn-primary" @onclick="SaveEdit" disabled="@isSavingEdit">@(isSavingEdit ? "Saving..." : "Save")</button>
                <button class="btn-trans" @onclick="() => isEditVisible = false">Cancel</button>
            </div>
        </div>
    </div>
}

@if (isDeleteModalVisible)
{
    <div class="modal-backdrop">
        <div class="modal-content">
            <h3 style="color:#e74c3c;">Delete Transaction?</h3>
            <p style="color:#ccc;">@selectedTrans.Desc</p>
            <label style="color:gray; font-size:12px;">Refund To (Optional):</label>
            <select @bind="refundAccountId" class="input-dark">
                <option value="">Just Delete (No Refund)</option>
                @foreach (var acc in myData.Accounts)
                {
                    <option value="@acc.Id">@acc.Name</option>
                }
            </select>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn-primary" style="background:#e74c3c;" @onclick="ExecuteDelete" disabled="@isDeleting">@(isDeleting ? "Deleting..." : "Delete")</button>
                <button class="btn-trans" @onclick="() => isDeleteModalVisible = false">Cancel</button>
            </div>
        </div>
    </div>
}

<style>
    .btn-trans {
        background: transparent;
        border: none;
        font-size: 16px;
        cursor: pointer;
        color: #888;
    }

    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 2000;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .modal-content {
        width: 85%;
        max-width: 350px;
        background: #1f1f1f;
        padding: 20px;
        border-radius: 15px;
        border: 1px solid #333;
        box-shadow: 0 4px 15px rgba(0,0,0,0.5);
    }

    .input-dark {
        width: 100%;
        background: #333;
        color: white;
        border: none;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 10px;
        box-sizing: border-box;
    }

    .btn-primary {
        background-color: #00E676;
        color: black;
        border: none;
        padding: 10px;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        flex: 1;
    }
</style>

@code {
    AppData myData = new AppData();
    Transaction selectedTrans = new Transaction();

    // UI Flags
    bool isEditVisible = false;
    bool isDeleteModalVisible = false;
    bool isSavingEdit = false;
    bool isDeleting = false;

    // Logic Vars
    string editAccountId = "";
    string refundAccountId = "";
    decimal oldAmount = 0;

    // 🔥 Filter Vars
    string selectedMonthStr = DateTime.Now.ToString("yyyy-MM");

    protected override async Task OnInitializedAsync()
    {
        myData = await Firebase.Load();
    }

    // 🔥 Filter Logic
    IEnumerable<Transaction> FilteredTransactions
    {
        get
        {
            if (string.IsNullOrEmpty(selectedMonthStr)) return myData.History.OrderByDescending(x => x.Date);

            if (DateTime.TryParse(selectedMonthStr + "-01", out DateTime selectedDate))
            {
                return myData.History
                    .Where(x => x.Date.Year == selectedDate.Year && x.Date.Month == selectedDate.Month)
                    .OrderByDescending(x => x.Date);
            }
            return new List<Transaction>();
        }
    }

    void EditTrans(Transaction t)
    {
        selectedTrans = t;
        oldAmount = t.Amount;
        isEditVisible = true;
    }

    async Task SaveEdit()
    {
        isSavingEdit = true;
        if (!string.IsNullOrEmpty(editAccountId))
        {
            var acc = myData.Accounts.FirstOrDefault(x => x.Id == editAccountId);
            if (acc != null)
            {
                // Revert old effect
                bool wasIncome = (selectedTrans.AmountDisplay ?? "").StartsWith("+");
                if (wasIncome) acc.Balance -= oldAmount; else acc.Balance += oldAmount;

                // Apply new effect
                // Note: We assume user didn't change sign logic here, just amount.
                // Ideally, edit should allow changing Income/Expense type too, but for simplicity:
                if (wasIncome) acc.Balance += selectedTrans.Amount; else acc.Balance -= selectedTrans.Amount;
            }
        }

        // Update Display String
        bool isPos = (selectedTrans.AmountDisplay ?? "").StartsWith("+");
        selectedTrans.AmountDisplay = (isPos ? "+" : "-") + selectedTrans.Amount.ToString("N2");

        await Firebase.Save(myData);
        isEditVisible = false;
        isSavingEdit = false;
    }

    void ConfirmDelete(Transaction t)
    {
        selectedTrans = t;
        isDeleteModalVisible = true;
    }

    async Task ExecuteDelete()
    {
        isDeleting = true;
        if (!string.IsNullOrEmpty(refundAccountId))
        {
            var acc = myData.Accounts.FirstOrDefault(x => x.Id == refundAccountId);
            if (acc != null)
            {
                bool isIncome = (selectedTrans.AmountDisplay ?? "").StartsWith("+");
                if (isIncome) acc.Balance -= selectedTrans.Amount; else acc.Balance += selectedTrans.Amount;
            }
        }
        myData.History.Remove(selectedTrans);
        await Firebase.Save(myData);
        isDeleteModalVisible = false;
        isDeleting = false;
    }
}