@page "/history"
@using FloosyWeb.Models
@inject FirebaseService Firebase
@inject IJSRuntime JS
@inject LocalizationService L

<div class="page-section" style="padding-bottom:88px;">

    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h3 style="margin:0;">@L.T("HistoryTitle")</h3>
    </div>

    <div class="card" style="padding:15px; margin-bottom:20px; background:#1f1f1f;">
        <label style="color:gray; font-size:12px;">@L.T("FilterByMonth")</label>
        <input type="month"
               value="@selectedMonthStr"
               @onchange="@(e => selectedMonthStr = e.Value?.ToString() ?? "")"
               class="input-dark"
               style="margin-bottom:0;" />
    </div>

    @if (!FilteredTransactions.Any())
    {
        <div style="text-align:center; padding:30px; color:gray;">
            <p>@L.T("NoTransactionsThisMonth")</p>
        </div>
    }
    else
    {
        @foreach (var t in FilteredTransactions)
        {
            <div style="background:#1f1f1f; padding:15px; border-left: 4px solid @t.ColorHex; margin-bottom:10px; border-radius:10px; display:flex; justify-content:space-between; align-items:center;">
                <div style="flex:1;">
                    <div style="color:@t.ColorHex; font-size:11px;">@t.Category</div>
                    <div style="font-weight:bold; color:white; font-size:1.1em;">@t.Desc</div>
                    <div style="color:gray; font-size:11px;">@t.Date.ToString("dd MMM, HH:mm")</div>
                </div>
                <div style="text-align:right;">
                    <div style="font-weight:bold; font-size:1.2em; color:@t.ColorHex; margin-bottom:5px;">@t.AmountDisplay</div>
                    <div style="display:flex; gap:10px; justify-content:flex-end;">
                        <button class="icon-btn" style="font-size:16px;" @onclick="() => EditTrans(t)" aria-label="Edit transaction" title="Edit transaction">✏️</button>
                        <button class="icon-btn" style="font-size:16px;" @onclick="() => ConfirmDelete(t)" aria-label="Delete transaction" title="Delete transaction">🗑️</button>
                    </div>
                </div>
            </div>
        }
    }
</div>

@if (isEditVisible)
{
    <AppModal Visible="@isEditVisible" Title="@L.T("EditTransaction")">
        <ChildContent>
            <AppInput Value="@(selectedTrans.Desc ?? string.Empty)"
                      ValueChanged="@(v => selectedTrans.Desc = v)"
                      Placeholder="@L.T("Description")" />
            <input type="number" @bind="selectedTrans.Amount" class="input-dark" placeholder="@L.T("Amount")" />

            <label style="font-size:12px; color:gray;">@L.T("UpdateBalanceOnAccount")</label>
            <AppSelect Value="@editAccountId"
                       ValueChanged="@(v => editAccountId = v)"
                       Options="@HistoryEditAccountOptions" />
        </ChildContent>
        <FooterContent>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <AppButton Text="@L.T("Save")"
                           LoadingText="Saving..."
                           IsLoading="@isSavingEdit"
                           Disabled="@isSavingEdit"
                           OnClick="@(async _ => await SaveEdit())" />
                <AppButton Text="@L.T("Cancel")"
                           Variant="ghost"
                           OnClick="@(_ => { isEditVisible = false; return Task.CompletedTask; })" />
            </div>
        </FooterContent>
    </AppModal>
}

@if (isDeleteModalVisible)
{
    <AppModal Visible="@isDeleteModalVisible" Title="@L.T("DeleteTransactionTitle")" Style="border:1px solid #e74c3c;">
        <ChildContent>
            <p style="color:#ccc;">@selectedTrans.Desc</p>
            <label style="color:gray; font-size:12px;">@L.T("RefundToOptional")</label>
            <AppSelect Value="@refundAccountId"
                       ValueChanged="@(v => refundAccountId = v)"
                       Options="@HistoryDeleteAccountOptions" />
        </ChildContent>
        <FooterContent>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <AppButton Text="@L.T("Delete")"
                           LoadingText="@L.T("Deleting")"
                           IsLoading="@isDeleting"
                           Disabled="@isDeleting"
                           Style="background:#e74c3c; color:white;"
                           OnClick="@(async _ => await ExecuteDelete())" />
                <AppButton Text="@L.T("Cancel")"
                           Variant="ghost"
                           OnClick="@(_ => { isDeleteModalVisible = false; return Task.CompletedTask; })" />
            </div>
        </FooterContent>
    </AppModal>
}

@code {
    AppData myData = new AppData();
    Transaction selectedTrans = new Transaction();

    // UI Flags
    bool isEditVisible = false;
    bool isDeleteModalVisible = false;
    bool isSavingEdit = false;
    bool isDeleting = false;

    // Logic Vars
    string editAccountId = "";
    string refundAccountId = "";
    decimal oldAmount = 0;

    // 🔥 Filter Vars
    string selectedMonthStr = DateTime.Now.ToString("yyyy-MM");

    IEnumerable<KeyValuePair<string, string>> HistoryEditAccountOptions =>
        new[] { new KeyValuePair<string, string>("", L.T("DontChangeBalanceTextOnly")) }
        .Concat(myData.Accounts.Select(acc => new KeyValuePair<string, string>(acc.Id, acc.Name ?? L.T("Account"))));

    IEnumerable<KeyValuePair<string, string>> HistoryDeleteAccountOptions =>
        new[] { new KeyValuePair<string, string>("", L.T("JustDeleteNoRefund")) }
        .Concat(myData.Accounts.Select(acc => new KeyValuePair<string, string>(acc.Id, acc.Name ?? L.T("Account"))));

    protected override async Task OnInitializedAsync()
    {
        myData = await Firebase.Load();
    }

    // 🔥 Filter Logic
    IEnumerable<Transaction> FilteredTransactions
    {
        get
        {
            if (string.IsNullOrEmpty(selectedMonthStr)) return myData.History.OrderByDescending(x => x.Date);

            if (DateTime.TryParse(selectedMonthStr + "-01", out DateTime selectedDate))
            {
                return myData.History
                    .Where(x => x.Date.Year == selectedDate.Year && x.Date.Month == selectedDate.Month)
                    .OrderByDescending(x => x.Date);
            }
            return new List<Transaction>();
        }
    }

    void EditTrans(Transaction t)
    {
        selectedTrans = t;
        oldAmount = t.Amount;
        isEditVisible = true;
    }

    async Task SaveEdit()
    {
        isSavingEdit = true;
        try
        {
            if (!string.IsNullOrEmpty(editAccountId))
            {
                var acc = myData.Accounts.FirstOrDefault(x => x.Id == editAccountId);
                if (acc != null)
                {
                    // Revert old effect
                    bool wasIncome = (selectedTrans.AmountDisplay ?? "").StartsWith("+");
                    if (wasIncome) acc.Balance -= oldAmount; else acc.Balance += oldAmount;

                    // Apply new effect
                    // Note: We assume user didn't change sign logic here, just amount.
                    // Ideally, edit should allow changing Income/Expense type too, but for simplicity:
                    if (wasIncome) acc.Balance += selectedTrans.Amount; else acc.Balance -= selectedTrans.Amount;
                }
            }

            // Update Display String
            bool isPos = (selectedTrans.AmountDisplay ?? "").StartsWith("+");
            selectedTrans.AmountDisplay = (isPos ? "+" : "-") + selectedTrans.Amount.ToString("N2");

            await Firebase.Save(myData);
            isEditVisible = false;
        }
        finally
        {
            isSavingEdit = false;
        }
    }

    void ConfirmDelete(Transaction t)
    {
        selectedTrans = t;
        isDeleteModalVisible = true;
    }

    async Task ExecuteDelete()
    {
        isDeleting = true;
        try
        {
            if (!string.IsNullOrEmpty(refundAccountId))
            {
                var acc = myData.Accounts.FirstOrDefault(x => x.Id == refundAccountId);
                if (acc != null)
                {
                    bool isIncome = (selectedTrans.AmountDisplay ?? "").StartsWith("+");
                    if (isIncome) acc.Balance -= selectedTrans.Amount; else acc.Balance += selectedTrans.Amount;
                }
            }

            myData.History.Remove(selectedTrans);
            await Firebase.Save(myData);
            isDeleteModalVisible = false;
        }
        finally
        {
            isDeleting = false;
        }
    }
}