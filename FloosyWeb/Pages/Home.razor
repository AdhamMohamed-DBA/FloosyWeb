@page "/home"
@using FloosyWeb.Models
@inject FirebaseService Firebase
@inject NavigationManager Nav
@inject IJSRuntime JS

<div style="padding: 20px; padding-bottom: 80px;">
    <div style="margin-bottom: 20px;">
        <h3 style="margin:0;">Welcome, @Firebase.GetUserName()! 👋</h3>
    </div>
    <div class="card" style="text-align:center; background: #1f1f1f; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
        <p style="color:gray; margin:0; font-size: 14px;">Total Balance</p>
        <h1 style="color:#00E676; margin:5px; font-size: 40px;">@TotalBalance.ToString("N2")</h1>
    </div>
</div>

@code {
    AppData myData = new AppData();
    decimal TotalBalance => myData.Accounts.Sum(x => x.Balance);
    string[] ColorPalette = { "#1f1f1f", "#2ecc71", "#e74c3c", "#3498db", "#9b59b6", "#f1c40f", "#e67e22", "#795548", "#607d8b" };

    bool isAddAccModalVisible = false, isAccOptionsVisible = false, isPickingColor = false;
    bool isTransModalVisible = false, isIncome = true, isTransferModalVisible = false;

    string newAccName = "", newAccColor = "#1f1f1f";
    decimal newAccBalance;
    Account? selectedAccount;

    string selectedAccountId = "", selectedCategory = "", transDesc = "";
    decimal transAmount;
    string transferFromId = "", transferToId = "";
    decimal transferAmount;

    protected override async Task OnInitializedAsync()
    {
        if (string.IsNullOrEmpty(Firebase.CurrentUserId)) { Nav.NavigateTo("/"); return; }
        myData = await Firebase.Load();
        if (myData.Accounts.Any()) selectedAccountId = myData.Accounts.First().Id;
        InitCats();
    }
    void InitCats() { if (!myData.IncomeCategories.Any()) myData.IncomeCategories = new System.Collections.ObjectModel.ObservableCollection<string> { "Salary", "Other" }; if (!myData.ExpenseCategories.Any()) myData.ExpenseCategories = new System.Collections.ObjectModel.ObservableCollection<string> { "Food", "Other" }; }

    // (Account Functions - Same as before)
    void ShowAddAccountModal() { newAccName = ""; newAccBalance = 0; newAccColor = "#1f1f1f"; isAddAccModalVisible = true; }
    async Task SaveNewAccount() { if (string.IsNullOrWhiteSpace(newAccName)) return; var acc = new Account { Name = newAccName, Balance = newAccBalance, ColorHex = newAccColor }; myData.Accounts.Add(acc); await Firebase.Save(myData); isAddAccModalVisible = false; }
    void OpenAccountOptions(Account acc) { selectedAccount = acc; isPickingColor = false; isAccOptionsVisible = true; }
    async Task UpdateAccountColor(string c) { if (selectedAccount == null) return; selectedAccount.ColorHex = c; await Firebase.Save(myData); isPickingColor = false; isAccOptionsVisible = false; }
    async Task EditAccountName() { if (selectedAccount == null) return; string n = await JS.InvokeAsync<string>("prompt", "Name:", selectedAccount.Name); if (!string.IsNullOrEmpty(n)) { selectedAccount.Name = n; await Firebase.Save(myData); } }
    async Task EditAccountBalance() { if (selectedAccount == null) return; string b = await JS.InvokeAsync<string>("prompt", "Balance:", selectedAccount.Balance); if (decimal.TryParse(b, out decimal d)) { selectedAccount.Balance = d; await Firebase.Save(myData); } }
    async Task DeleteAccount() { if (selectedAccount != null && await JS.InvokeAsync<bool>("confirm", "Delete?")) { myData.Accounts.Remove(selectedAccount); await Firebase.Save(myData); isAccOptionsVisible = false; } }

    void ShowTransactionModal(bool inc)
    {
        isIncome = inc; transAmount = 0; isTransModalVisible = true;
        selectedCategory = (isIncome ? myData.IncomeCategories.FirstOrDefault() : myData.ExpenseCategories.FirstOrDefault()) ?? "Other";
    }

    // 🔥 UPDATED: Saving Amount correctly
    async Task SaveTransaction()
    {
        var acc = myData.Accounts.FirstOrDefault(x => x.Id == selectedAccountId);
        if (acc == null) return;
        if (isIncome) acc.Balance += transAmount; else acc.Balance -= transAmount;

        myData.History.Add(new Transaction
        {
            Desc = string.IsNullOrEmpty(transDesc) ? selectedCategory : transDesc,
            Category = selectedCategory,
            Amount = transAmount, // ✅ NEW FIELD
            AmountDisplay = isIncome ? $"+{transAmount:N2}" : $"-{transAmount:N2}",
            ColorHex = isIncome ? "#2ecc71" : "#e74c3c",
            Date = DateTime.Now
        });
        await Firebase.Save(myData); isTransModalVisible = false;
    }

    void ShowTransferModal() { if (myData.Accounts.Count < 2) return; transferFromId = myData.Accounts[0].Id; transferToId = myData.Accounts[1].Id; transferAmount = 0; isTransferModalVisible = true; }

    // 🔥 UPDATED: Saving Amount correctly
    async Task SaveTransfer()
    {
        var f = myData.Accounts.FirstOrDefault(x => x.Id == transferFromId);
        var t = myData.Accounts.FirstOrDefault(x => x.Id == transferToId);
        if (f != null && t != null && f.Balance >= transferAmount)
        {
            f.Balance -= transferAmount; t.Balance += transferAmount;
            myData.History.Add(new Transaction
            {
                Desc = $"Trf {f.Name}->{t.Name}",
                Category = "Transfer",
                Amount = transferAmount, // ✅ NEW FIELD
                AmountDisplay = $"{transferAmount:N2}",
                ColorHex = "#3498db",
                Date = DateTime.Now
            });
            await Firebase.Save(myData); isTransferModalVisible = false;
        }
    }
}