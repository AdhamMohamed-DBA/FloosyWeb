@page "/settings"
@using FloosyWeb.Models
@inject FirebaseService Firebase
@inject NavigationManager Nav
@inject IJSRuntime JS

<div class="page-section" style="padding-bottom:88px;">

    <div style="text-align:center; margin-bottom:30px;">
        <img src="images/appicon.png" style="width:80px; height:80px; border-radius:15px;" />
        <h3 style="margin: 10px 0 5px 0;">Settings</h3>
        <p style="color:gray; font-size:14px; margin:0;">@userEmail</p>
    </div>

    <div class="setting-card">
        <label>Account Management</label>

        <div class="input-stack" style="margin-bottom:20px; border-bottom:1px solid #333; padding-bottom:20px;">
            <label style="font-size:11px; color:#ccc;">Change Email</label>
            <AppInput Value="@newEmailInput"
                      ValueChanged="@(v => newEmailInput = v)"
                      Placeholder="New Email Address"
                      AriaLabel="New email address" />
            <AppInput Type="password"
                      Value="@emailPassInput"
                      ValueChanged="@(v => emailPassInput = v)"
                      Placeholder="Current Password"
                      AriaLabel="Current password" />
            <AppButton Text="Update Email"
                       LoadingText="Updating..."
                       IsLoading="@isUpdatingEmail"
                       Disabled="@isUpdatingEmail"
                       Style="width:100%;"
                       OnClick="@(async _ => await DoUpdateEmail())" />
        </div>

        <label style="font-size:11px; color:#e74c3c;">Danger Zone</label>
        <button class="btn-logout" @onclick="() => isDeleteConfirmVisible = true">üóëÔ∏è Delete Account</button>
    </div>

    <div class="setting-card">
        <label>Security</label>
        <div class="input-stack">
            <div style="display:flex; align-items:center; gap:10px; white-space:nowrap;">
                <span>Biometric unlock (this device)</span>
                <input type="checkbox" checked="@useBiometric" @onchange="ToggleBiometric" aria-label="Enable biometric unlock" />
            </div>
            <p style="color:gray; font-size:10px; margin-top:5px;">
                Uses Face ID / fingerprint when supported. On devices without biometrics, login stays password-only.
            </p>
        </div>
    </div>

    <div class="setting-card">
        <label>Start of Month (Salary Day)</label>
        <div class="input-stack">
            <input type="number" min="1" max="28" @bind="financialDay" class="input-dark" placeholder="e.g. 25" style="text-align:center;" />
            <AppButton Text="Save"
                       LoadingText="Saving..."
                       IsLoading="@isSavingFinancialDay"
                       Disabled="@isSavingFinancialDay"
                       Style="width:100%;"
                       OnClick="@(async _ => await UpdateFinancialDay())" />
        </div>
        <p style="color:gray; font-size:10px; margin-top:5px;">
            Example: If set to 25, transactions from Feb 25th will appear in March charts.
        </p>
    </div>

    <div class="setting-card">
        <label>Display Name</label>
        <div class="input-stack">
            <AppInput Value="@newName"
                      ValueChanged="@(v => newName = v)"
                      Placeholder="Your Name" />
            <AppButton Text="Save"
                       LoadingText="Saving..."
                       IsLoading="@isUpdatingName"
                       Disabled="@isUpdatingName"
                       Style="width:100%;"
                       OnClick="@(async _ => await UpdateName())" />
        </div>
    </div>

    <div class="setting-card">
        <label>Change Password</label>
        <div class="input-stack">
            <AppInput Type="password"
                      Value="@oldPass"
                      ValueChanged="@(v => oldPass = v)"
                      Placeholder="Old Password" />
            <AppInput Type="password"
                      Value="@newPass"
                      ValueChanged="@(v => newPass = v)"
                      Placeholder="New Password" />
            <AppButton Text="Update Password"
                       LoadingText="Updating..."
                       IsLoading="@isUpdatingPassword"
                       Disabled="@isUpdatingPassword"
                       Style="width:100%;"
                       OnClick="@(async _ => await UpdatePass())" />
        </div>
    </div>

    <div class="setting-card">
        <label>Support</label>
        <a href="https://wa.me/201009582510" target="_blank" class="btn-whatsapp">
            <span>üí¨</span> Contact via WhatsApp
        </a>
    </div>

    <button class="btn-logout" style="margin-top:20px;" @onclick="@(async () => await SignOut())">Sign Out</button>
</div>

@if (isMessageVisible)
{
    <AppModal Visible="@isMessageVisible" Style="text-align:center;">
        <ChildContent>
            <h3 style="margin-top:0; color:@(messageType == "Success" ? "#00E676" : "#e74c3c");">@messageTitle</h3>
            <p style="color:#ccc; margin-bottom:20px; font-size:14px;">@messageBody</p>
        </ChildContent>
        <FooterContent>
            <AppButton Text="OK"
                       Style="width:100%;"
                       OnClick="@(_ => { isMessageVisible = false; return Task.CompletedTask; })" />
        </FooterContent>
    </AppModal>
}

@if (isDeleteConfirmVisible)
{
    <AppModal Visible="@isDeleteConfirmVisible" Style="text-align:center; border: 1px solid #e74c3c;">
        <ChildContent>
            <h3 style="margin-top:0; color:#e74c3c;">Delete Account?</h3>
            <p style="color:#ccc; margin-bottom:15px; font-size:14px;">This action cannot be undone. All your data will be lost.</p>

            <input @bind="deletePassInput" type="password" class="input-dark" placeholder="Confirm Password" style="margin-bottom:15px;" />
        </ChildContent>
        <FooterContent>
            <div style="display:flex; gap:10px;">
                <AppButton Text="Yes, Delete"
                           Style="background:#e74c3c; color:white;"
                           OnClick="@(async _ => await DoDeleteAccount())" />
                <AppButton Text="Cancel"
                           Variant="ghost"
                           Style="background:#333; color:white;"
                           OnClick="@(_ => { isDeleteConfirmVisible = false; return Task.CompletedTask; })" />
            </div>
        </FooterContent>
    </AppModal>
}

@code {
    AppData myData = new AppData();
    string newName = "", oldPass = "", newPass = "";
    int financialDay = 1;
    string userEmail = "";

    string newEmailInput = "";
    string emailPassInput = "";
    string deletePassInput = "";
    bool isDeleteConfirmVisible = false;

    bool isMessageVisible = false;
    string messageTitle = "", messageBody = "", messageType = "Info";

    bool useBiometric = false;
    bool isUpdatingEmail = false;
    bool isSavingFinancialDay = false;
    bool isUpdatingName = false;
    bool isUpdatingPassword = false;

    void ShowMessage(string title, string body, string type = "Info")
    {
        messageTitle = title; messageBody = body; messageType = type; isMessageVisible = true;
    }

    protected override async Task OnInitializedAsync()
    {
        myData = await Firebase.Load();
        financialDay = myData.FinancialStartDay;
        if (financialDay < 1) financialDay = 1;

        newName = Firebase.GetUserName();
        userEmail = Firebase.UserEmail ?? "No Email";

        try
        {
            useBiometric = await JS.InvokeAsync<bool>("floosyBiometric.isEnabled");
        }
        catch
        {
            useBiometric = false;
        }
    }

    async Task UpdateFinancialDay()
    {
        isSavingFinancialDay = true;
        try
        {
            if (financialDay < 1 || financialDay > 28) { ShowMessage("Error", "Day must be between 1 and 28", "Error"); return; }
            myData.FinancialStartDay = financialDay;
            await Firebase.Save(myData);
            ShowMessage("Success", "Financial start day updated!", "Success");
        }
        finally
        {
            isSavingFinancialDay = false;
        }
    }

    async Task UpdateName()
    {
        isUpdatingName = true;
        try
        {
            if (string.IsNullOrWhiteSpace(newName)) return;
            await Firebase.UpdateUserName(newName);
            ShowMessage("Success", "Name updated!", "Success");
        }
        finally
        {
            isUpdatingName = false;
        }
    }

    async Task UpdatePass()
    {
        isUpdatingPassword = true;
        try
        {
            if (string.IsNullOrWhiteSpace(oldPass) || string.IsNullOrWhiteSpace(newPass)) { ShowMessage("Error", "Enter old and new password.", "Error"); return; }
            // üî• FIX: Check for Null Email before calling Login (CS8604)
            if (string.IsNullOrEmpty(Firebase.UserEmail)) { ShowMessage("Error", "User email not found.", "Error"); return; }

            // Use '?? ""' safely because we checked it's not null/empty above
            var verify = await Firebase.Login(Firebase.UserEmail ?? "", oldPass);
            if (verify != "Success") { ShowMessage("Failed", "Old password incorrect!", "Error"); return; }

            var res = await Firebase.ChangePassword(newPass);
            ShowMessage(res == "Success" ? "Success" : "Info", res, res == "Success" ? "Success" : "Error");
            oldPass = ""; newPass = "";
        }
        finally
        {
            isUpdatingPassword = false;
        }
    }

    async Task DoUpdateEmail()
    {
        isUpdatingEmail = true;
        try
        {
            if (string.IsNullOrWhiteSpace(newEmailInput) || string.IsNullOrWhiteSpace(emailPassInput))
            {
                ShowMessage("Error", "Enter new email and current password.", "Error");
                return;
            }

            var currentEmail = Firebase.UserEmail ?? "";
            if (string.IsNullOrEmpty(currentEmail)) { ShowMessage("Error", "User not found.", "Error"); return; }

            var verify = await Firebase.Login(currentEmail, emailPassInput);
            if (verify != "Success") { ShowMessage("Failed", "Password incorrect!", "Error"); return; }

            var res = await Firebase.UpdateEmail(newEmailInput);
            if (res == "Success")
            {
                userEmail = newEmailInput;
                ShowMessage("Success", "Email updated successfully!", "Success");
                newEmailInput = ""; emailPassInput = "";
            }
            else ShowMessage("Error", res, "Error");
        }
        finally
        {
            isUpdatingEmail = false;
        }
    }

    async Task DoDeleteAccount()
    {
        if (string.IsNullOrWhiteSpace(deletePassInput)) { return; }

        var currentEmail = Firebase.UserEmail ?? "";
        if (string.IsNullOrEmpty(currentEmail)) { ShowMessage("Error", "User not found.", "Error"); return; }

        var verify = await Firebase.Login(currentEmail, deletePassInput);
        if (verify != "Success")
        {
            ShowMessage("Failed", "Password incorrect! Cannot delete.", "Error");
            return;
        }

        var res = await Firebase.DeleteUser();
        if (res == "Success") Nav.NavigateTo("", forceLoad: true);
        else
        {
            ShowMessage("Error", res, "Error");
            isDeleteConfirmVisible = false;
        }
    }

    async Task ToggleBiometric(ChangeEventArgs e)
    {
        var target = e.Value is bool b && b;

        if (target)
        {
            bool supported = false;
            try
            {
                supported = await JS.InvokeAsync<bool>("floosyBiometric.isSupported");
            }
            catch { supported = false; }

            if (!supported)
            {
                ShowMessage("Not Supported", "Biometric unlock is not available on this device.", "Error");
                useBiometric = false;
                return;
            }

            var ok = await JS.InvokeAsync<bool>("floosyBiometric.register");
            if (!ok)
            {
                ShowMessage("Failed", "Could not enable biometric unlock on this device.", "Error");
                useBiometric = false;
                return;
            }

            useBiometric = true;
        }
        else
        {
            try { await JS.InvokeVoidAsync("floosyBiometric.disable"); } catch { }
            useBiometric = false;
        }
    }

    async Task SignOut()
    {
        try { await JS.InvokeVoidAsync("floosyBiometric.disable"); } catch { }
        Firebase.SignOut();
        Nav.NavigateTo("", forceLoad: true);
    }
}