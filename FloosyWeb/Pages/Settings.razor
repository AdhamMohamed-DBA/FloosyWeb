@page "/settings"
@using FloosyWeb.Models
@inject FirebaseService Firebase
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject LocalizationService L

<div class="page-section" style="padding-bottom:88px;">

    <div style="text-align:center; margin-bottom:30px;">
        <img src="images/appicon.png" style="width:80px; height:80px; border-radius:15px;" />
        <h3 style="margin: 10px 0 5px 0;">@L.T("Settings")</h3>
        <p style="color:gray; font-size:14px; margin:0;">@userEmail</p>
    </div>

    <div class="setting-card">
        <label>@L.T("Language")</label>
        <div style="display:flex; gap:8px; margin-top:8px;">
            <AppButton Text="@L.T("English")"
                       Style="@LanguageEnglishButtonStyle"
                       OnClick="@(async _ => await SetLanguage("en"))" />
            <AppButton Text="@L.T("Arabic")"
                       Style="@LanguageArabicButtonStyle"
                       OnClick="@(async _ => await SetLanguage("ar"))" />
        </div>
    </div>

    <div class="setting-card">
        <label>@L.T("AccountManagement")</label>

        <div class="input-stack" style="margin-bottom:20px; border-bottom:1px solid #333; padding-bottom:20px;">
            <label style="font-size:11px; color:#ccc;">@L.T("ChangeEmail")</label>
            <AppInput Value="@newEmailInput"
                      ValueChanged="@(v => newEmailInput = v)"
                      Placeholder="@L.T("NewEmailAddress")"
                      AriaLabel="New email address" />
            <AppInput Type="password"
                      Value="@emailPassInput"
                      ValueChanged="@(v => emailPassInput = v)"
                      Placeholder="@L.T("CurrentPassword")"
                      AriaLabel="Current password" />
            <AppButton Text="@L.T("UpdateEmail")"
                       LoadingText="@L.T("Updating")"
                       IsLoading="@isUpdatingEmail"
                       Disabled="@isUpdatingEmail"
                       Style="width:100%;"
                       OnClick="@(async _ => await DoUpdateEmail())" />
        </div>

        <label style="font-size:11px; color:#e74c3c;">@L.T("DangerZone")</label>
        <button class="btn-logout" @onclick="() => isDeleteConfirmVisible = true">@L.T("DeleteAccountAction")</button>
    </div>

    <div class="setting-card">
        <label>@L.T("Security")</label>
        <div class="input-stack">
            <div style="display:flex; align-items:center; gap:10px; white-space:nowrap;">
                <span>@L.T("BiometricUnlock")</span>
                <input type="checkbox" checked="@useBiometric" @onchange="ToggleBiometric" aria-label="Enable biometric unlock" />
            </div>
            <p style="color:gray; font-size:10px; margin-top:5px;">
                @L.T("BiometricHint")
            </p>
        </div>
    </div>

    <div class="setting-card">
        <label>@L.T("StartOfMonth")</label>
        <div class="input-stack">
            <input type="number" min="1" max="28" @bind="financialDay" class="input-dark" placeholder="e.g. 25" style="text-align:center;" />
            <AppButton Text="@L.T("Save")"
                       LoadingText="Saving..."
                       IsLoading="@isSavingFinancialDay"
                       Disabled="@isSavingFinancialDay"
                       Style="width:100%;"
                       OnClick="@(async _ => await UpdateFinancialDay())" />
        </div>
        <p style="color:gray; font-size:10px; margin-top:5px;">
            @L.T("SalaryDayExample")
        </p>
    </div>

    <div class="setting-card">
        <label>@L.T("DisplayName")</label>
        <div class="input-stack">
            <AppInput Value="@newName"
                      ValueChanged="@(v => newName = v)"
                      Placeholder="@L.T("YourName")" />
            <AppButton Text="@L.T("Save")"
                       LoadingText="Saving..."
                       IsLoading="@isUpdatingName"
                       Disabled="@isUpdatingName"
                       Style="width:100%;"
                       OnClick="@(async _ => await UpdateName())" />
        </div>
    </div>

    <div class="setting-card">
        <label>@L.T("ChangePassword")</label>
        <div class="input-stack">
            <AppInput Type="password"
                      Value="@oldPass"
                      ValueChanged="@(v => oldPass = v)"
                      Placeholder="@L.T("OldPassword")" />
            <AppInput Type="password"
                      Value="@newPass"
                      ValueChanged="@(v => newPass = v)"
                      Placeholder="@L.T("NewPassword")" />
            <AppButton Text="@L.T("UpdatePassword")"
                       LoadingText="@L.T("Updating")"
                       IsLoading="@isUpdatingPassword"
                       Disabled="@isUpdatingPassword"
                       Style="width:100%;"
                       OnClick="@(async _ => await UpdatePass())" />
        </div>
    </div>

    <div class="setting-card">
        <label>@L.T("Support")</label>
        <a href="https://wa.me/201009582510" target="_blank" class="btn-whatsapp">
            @L.T("ContactWhatsapp")
        </a>
    </div>

    @if (isCurrentUserAdmin)
    {
        <div class="setting-card">
            <label>@L.T("UpdateBroadcast")</label>
            <div class="input-stack">
                <label style="font-size:11px; color:#ccc;">@L.T("RequiredVersion")</label>
                <AppInput Value="@requiredVersionInput"
                          ValueChanged="@(v => requiredVersionInput = v)"
                          Placeholder="@L.T("RequiredVersionPlaceholder")" />

                <AppInput Value="@updateVersionInput"
                          ValueChanged="@(v => updateVersionInput = v)"
                          Placeholder="@L.T("VersionPlaceholder")" />

                <div style="display:flex; gap:8px;">
                    <AppButton Text="@L.T("AlignEnglish")"
                               Style="@AlignEnglishButtonStyle"
                               OnClick="@(_ => { updateMessageAlignmentInput = "ltr"; return Task.CompletedTask; })" />
                    <AppButton Text="@L.T("AlignArabic")"
                               Style="@AlignArabicButtonStyle"
                               OnClick="@(_ => { updateMessageAlignmentInput = "rtl"; return Task.CompletedTask; })" />
                </div>

                <textarea @bind="updateMessageInput"
                          class="input-dark"
                          style="text-align:@(updateMessageAlignmentInput == "rtl" ? "right" : "left");"
                          dir="@updateMessageAlignmentInput"
                          rows="4"
                          placeholder="@L.T("UpdateMessagePlaceholder")"></textarea>

                <div style="display:flex; align-items:center; gap:8px; margin:4px 0 10px 0;">
                    <input type="checkbox" @bind="isUpdateRequiredInput" style="width:16px; height:16px; accent-color:#00E676;" />
                    <span style="color:#ccc; font-size:12px;">@L.T("ForceUpdateForOlderVersions")</span>
                </div>

                <AppButton Text="@L.T("SaveUpdateMessage")"
                           LoadingText="Saving..."
                           IsLoading="@isSavingUpdateNotice"
                           Disabled="@isSavingUpdateNotice"
                           Style="width:100%;"
                           OnClick="@(async _ => await SaveUpdateNotice())" />
            </div>
        </div>
    }

    <button class="btn-logout" style="margin-top:20px;" @onclick="@(async () => await SignOut())">@L.T("SignOut")</button>
</div>

@if (isMessageVisible)
{
    <AppModal Visible="@isMessageVisible" Style="text-align:center;">
        <ChildContent>
            <h3 style="margin-top:0; color:@(messageType == "Success" ? "#00E676" : "#e74c3c");">@messageTitle</h3>
            <p style="color:#ccc; margin-bottom:20px; font-size:14px;">@messageBody</p>
        </ChildContent>
        <FooterContent>
            <AppButton Text="@L.T("Ok")"
                       Style="width:100%;"
                       OnClick="@(_ => { isMessageVisible = false; return Task.CompletedTask; })" />
        </FooterContent>
    </AppModal>
}

@if (isDeleteConfirmVisible)
{
    <AppModal Visible="@isDeleteConfirmVisible" Style="text-align:center; border: 1px solid #e74c3c;">
        <ChildContent>
            <h3 style="margin-top:0; color:#e74c3c;">@L.T("DeleteAccountPrompt")</h3>
            <p style="color:#ccc; margin-bottom:15px; font-size:14px;">@L.T("DeleteAccountWarning")</p>

            <input @bind="deletePassInput" type="password" class="input-dark" placeholder="@L.T("ConfirmPassword")" style="margin-bottom:15px;" />
        </ChildContent>
        <FooterContent>
            <div style="display:flex; gap:10px;">
                <AppButton Text="@L.T("YesDelete")"
                           Style="background:#e74c3c; color:white;"
                           OnClick="@(async _ => await DoDeleteAccount())" />
                <AppButton Text="@L.T("Cancel")"
                           Variant="ghost"
                           Style="background:#333; color:white;"
                           OnClick="@(_ => { isDeleteConfirmVisible = false; return Task.CompletedTask; })" />
            </div>
        </FooterContent>
    </AppModal>
}

@code {
    AppData myData = new AppData();
    string newName = "", oldPass = "", newPass = "";
    int financialDay = 1;
    string userEmail = "";

    string newEmailInput = "";
    string emailPassInput = "";
    string deletePassInput = "";
    bool isDeleteConfirmVisible = false;

    bool isMessageVisible = false;
    string messageTitle = "", messageBody = "", messageType = "Info";

    bool useBiometric = false;
    bool isUpdatingEmail = false;
    bool isSavingFinancialDay = false;
    bool isUpdatingName = false;
    bool isUpdatingPassword = false;
    bool isSavingUpdateNotice = false;
    bool isCurrentUserAdmin = false;

    string updateVersionInput = "";
    string requiredVersionInput = "";
    string updateMessageInput = "";
    string updateMessageAlignmentInput = "ltr";
    bool isUpdateRequiredInput = false;

    string LanguageEnglishButtonStyle =>
        $"flex:1; background:{(L.CurrentLanguage == "en" ? "#00E676" : "#333")}; color:{(L.CurrentLanguage == "en" ? "black" : "white")};";

    string LanguageArabicButtonStyle =>
        $"flex:1; background:{(L.CurrentLanguage == "ar" ? "#00E676" : "#333")}; color:{(L.CurrentLanguage == "ar" ? "black" : "white")};";

    string AlignEnglishButtonStyle =>
        $"flex:1; background:{(updateMessageAlignmentInput == "ltr" ? "#00E676" : "#333")}; color:{(updateMessageAlignmentInput == "ltr" ? "black" : "white")};";

    string AlignArabicButtonStyle =>
        $"flex:1; background:{(updateMessageAlignmentInput == "rtl" ? "#00E676" : "#333")}; color:{(updateMessageAlignmentInput == "rtl" ? "black" : "white")};";

    void ShowMessage(string title, string body, string type = "Info")
    {
        messageTitle = title; messageBody = body; messageType = type; isMessageVisible = true;
    }

    protected override async Task OnInitializedAsync()
    {
        myData = await Firebase.Load();
        financialDay = myData.FinancialStartDay;
        if (financialDay < 1) financialDay = 1;

        newName = Firebase.GetUserName();
        userEmail = Firebase.UserEmail ?? "No Email";

        isCurrentUserAdmin = await Firebase.IsCurrentUserAdmin();
        if (isCurrentUserAdmin)
        {
            var broadcast = await Firebase.LoadUpdateBroadcast();
            updateVersionInput = broadcast.Version;
            requiredVersionInput = string.IsNullOrWhiteSpace(broadcast.RequiredVersion) ? broadcast.Version : broadcast.RequiredVersion;
            updateMessageInput = broadcast.Message;
            updateMessageAlignmentInput = string.Equals(broadcast.MessageAlignment, "rtl", StringComparison.OrdinalIgnoreCase) ? "rtl" : "ltr";
            isUpdateRequiredInput = broadcast.IsRequired;
        }

        try
        {
            useBiometric = await JS.InvokeAsync<bool>("floosyBiometric.isEnabled");
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"[Settings.OnInitializedAsync] Failed to check biometric enabled state: {ex.Message}");
            useBiometric = false;
        }
    }

    async Task UpdateFinancialDay()
    {
        isSavingFinancialDay = true;
        try
        {
            if (financialDay < 1 || financialDay > 28) { ShowMessage(L.T("Error"), L.T("FinancialDayRange"), L.T("Error")); return; }
            myData.FinancialStartDay = financialDay;
            await Firebase.Save(myData);
            ShowMessage(L.T("Success"), L.T("FinancialDayUpdated"), L.T("Success"));
        }
        finally
        {
            isSavingFinancialDay = false;
        }
    }

    async Task UpdateName()
    {
        isUpdatingName = true;
        try
        {
            if (string.IsNullOrWhiteSpace(newName)) return;
            await Firebase.UpdateUserName(newName);
            ShowMessage(L.T("Success"), L.T("NameUpdated"), L.T("Success"));
        }
        finally
        {
            isUpdatingName = false;
        }
    }

    async Task UpdatePass()
    {
        isUpdatingPassword = true;
        try
        {
            if (string.IsNullOrWhiteSpace(oldPass) || string.IsNullOrWhiteSpace(newPass)) { ShowMessage(L.T("Error"), L.T("EnterOldNewPassword"), L.T("Error")); return; }
            // ðŸ”¥ FIX: Check for Null Email before calling Login (CS8604)
            if (string.IsNullOrEmpty(Firebase.UserEmail)) { ShowMessage(L.T("Error"), L.T("UserEmailNotFound"), L.T("Error")); return; }

            // Use '?? ""' safely because we checked it's not null/empty above
            var verify = await Firebase.Login(Firebase.UserEmail ?? "", oldPass);
            if (verify != "Success") { ShowMessage(L.T("Error"), L.T("OldPasswordIncorrect"), L.T("Error")); return; }

            var res = await Firebase.ChangePassword(newPass);
            ShowMessage(res == "Success" ? L.T("Success") : L.T("Error"), res, res == "Success" ? L.T("Success") : L.T("Error"));
            oldPass = ""; newPass = "";
        }
        finally
        {
            isUpdatingPassword = false;
        }
    }

    async Task DoUpdateEmail()
    {
        isUpdatingEmail = true;
        try
        {
            if (string.IsNullOrWhiteSpace(newEmailInput) || string.IsNullOrWhiteSpace(emailPassInput))
            {
                ShowMessage(L.T("Error"), L.T("EnterNewEmailCurrentPassword"), L.T("Error"));
                return;
            }

            var currentEmail = Firebase.UserEmail ?? "";
            if (string.IsNullOrEmpty(currentEmail)) { ShowMessage(L.T("Error"), L.T("UserNotFound"), L.T("Error")); return; }

            var verify = await Firebase.Login(currentEmail, emailPassInput);
            if (verify != "Success") { ShowMessage(L.T("Error"), L.T("PasswordIncorrect"), L.T("Error")); return; }

            var res = await Firebase.UpdateEmail(newEmailInput);
            if (res == "Success")
            {
                userEmail = newEmailInput;
                ShowMessage(L.T("Success"), L.T("EmailUpdatedSuccessfully"), L.T("Success"));
                newEmailInput = ""; emailPassInput = "";
            }
            else ShowMessage(L.T("Error"), res, L.T("Error"));
        }
        finally
        {
            isUpdatingEmail = false;
        }
    }

    async Task DoDeleteAccount()
    {
        if (string.IsNullOrWhiteSpace(deletePassInput)) { return; }

        var currentEmail = Firebase.UserEmail ?? "";
        if (string.IsNullOrEmpty(currentEmail)) { ShowMessage(L.T("Error"), L.T("UserNotFound"), L.T("Error")); return; }

        var verify = await Firebase.Login(currentEmail, deletePassInput);
        if (verify != "Success")
        {
            ShowMessage(L.T("Error"), L.T("PasswordIncorrectCannotDelete"), L.T("Error"));
            return;
        }

        var res = await Firebase.DeleteUser();
        if (res == "Success") Nav.NavigateTo("", forceLoad: true);
        else
        {
            ShowMessage(L.T("Error"), res, L.T("Error"));
            isDeleteConfirmVisible = false;
        }
    }

    async Task SaveUpdateNotice()
    {
        isSavingUpdateNotice = true;
        try
        {
            if (!await Firebase.IsCurrentUserAdmin())
            {
                ShowMessage(L.T("Error"), L.T("Unauthorized"), L.T("Error"));
                return;
            }

            updateVersionInput = (updateVersionInput ?? "").Trim();
            requiredVersionInput = (requiredVersionInput ?? "").Trim();
            updateMessageInput = (updateMessageInput ?? "").Trim();

            if (isUpdateRequiredInput)
            {
                if (string.IsNullOrWhiteSpace(updateVersionInput))
                {
                    ShowMessage(L.T("Error"), L.T("PleaseAddVersion"), L.T("Error"));
                    return;
                }

                if (string.IsNullOrWhiteSpace(requiredVersionInput))
                {
                    ShowMessage(L.T("Error"), L.T("PleaseAddRequiredVersion"), L.T("Error"));
                    return;
                }

                if (string.IsNullOrWhiteSpace(updateMessageInput))
                {
                    ShowMessage(L.T("Error"), L.T("PleaseAddUpdateMessage"), L.T("Error"));
                    return;
                }
            }

            await Firebase.SaveUpdateBroadcast(new UpdateBroadcast
            {
                Version = updateVersionInput,
                RequiredVersion = requiredVersionInput,
                Message = updateMessageInput,
                MessageAlignment = updateMessageAlignmentInput,
                IsRequired = isUpdateRequiredInput,
                UpdatedAt = DateTime.UtcNow
            });
            ShowMessage(L.T("Success"), L.T("UpdateSaved"), L.T("Success"));
        }
        finally
        {
            isSavingUpdateNotice = false;
        }
    }

    async Task ToggleBiometric(ChangeEventArgs e)
    {
        var target = e.Value is bool b && b;

        if (target)
        {
            bool supported = false;
            try
            {
                supported = await JS.InvokeAsync<bool>("floosyBiometric.isSupported");
            }
            catch (Exception ex)
            {
                Console.Error.WriteLine($"[Settings.ToggleBiometric] Failed to detect biometric support: {ex.Message}");
                supported = false;
            }

            if (!supported)
            {
                ShowMessage(L.T("NotSupported"), L.T("BiometricNotSupportedDevice"), L.T("Error"));
                useBiometric = false;
                return;
            }

            var ok = await JS.InvokeAsync<bool>("floosyBiometric.register");
            if (!ok)
            {
                ShowMessage(L.T("Error"), L.T("CouldNotEnableBiometric"), L.T("Error"));
                useBiometric = false;
                return;
            }

            useBiometric = true;
        }
        else
        {
            try { await JS.InvokeVoidAsync("floosyBiometric.disable"); }
            catch (Exception ex)
            {
                Console.Error.WriteLine($"[Settings.ToggleBiometric] Failed to disable biometric: {ex.Message}");
            }
            useBiometric = false;
        }
    }

    async Task SignOut()
    {
        try { await JS.InvokeVoidAsync("floosyBiometric.disable"); }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"[Settings.SignOut] Failed to disable biometric before sign-out: {ex.Message}");
        }
        Firebase.SignOut();
        Nav.NavigateTo("", forceLoad: true);
    }

    async Task SetLanguage(string lang)
    {
        await L.SetLanguageAsync(lang);
        await InvokeAsync(StateHasChanged);
    }
}