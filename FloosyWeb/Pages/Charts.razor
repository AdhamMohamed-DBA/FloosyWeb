@page "/charts"
@using FloosyWeb.Models
@inject FirebaseService Firebase

<div class="page-section" style="padding-bottom: 88px;">
    <h3>Analytics 📊</h3>

    <div class="kpi-grid">
        <div class="kpi-card">
            <div class="kpi-label">Income</div>
            <div class="kpi-value" style="color:#2ecc71;">+@CurrentIncome.ToString("N0")</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Expense</div>
            <div class="kpi-value" style="color:#e74c3c;">-@Math.Abs(CurrentExpense).ToString("N0")</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Net</div>
            <div class="kpi-value" style="color:@(NetAmount >= 0 ? "#2ecc71" : "#e74c3c");">@NetAmount.ToString("N0")</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">vs Prev Month</div>
            <div class="kpi-value" style="color:@(MoMDelta >= 0 ? "#2ecc71" : "#e74c3c");">@MoMDelta.ToString("N0")</div>
        </div>
    </div>

    <div class="card" style="padding:15px; margin-bottom:15px; background:#1f1f1f;">

        <div style="display:flex; gap:10px; margin-bottom:10px;">
            <button class="btn-primary" style="flex:1; background-color:@(isLifetime ? "#333" : "#00E676"); color:@(isLifetime ? "white" : "black")" @onclick="() => isLifetime = false" aria-label="Switch to monthly analytics">📅 Monthly</button>
            <button class="btn-primary" style="flex:1; background-color:@(isLifetime ? "#00E676" : "#333"); color:@(isLifetime ? "black" : "white")" @onclick="() => isLifetime = true" aria-label="Switch to lifetime analytics">♾️ Lifetime</button>
        </div>

        @if (!isLifetime)
        {
            <label style="color:gray; font-size:12px;">Select Month</label>
            <input type="month"
                   value="@selectedMonthStr"
                   @onchange="@(e => selectedMonthStr = e.Value?.ToString() ?? "")"
                   class="input-dark"
                   style="margin-bottom:0;" />
        }
    </div>

    <div style="margin-bottom:5px; font-size:12px; color:gray;">@(isLifetime ? "Lifetime Total" : "Selected Month")</div>

    <div style="background:#333; height:30px; border-radius:15px; overflow:hidden; display:flex; margin-bottom:10px;">
        @if (TotalVolume > 0)
        {
            <div style="width:@(IncomePct)%; background-color:#2ecc71; display:flex; align-items:center; justify-content:center; color:black; font-weight:bold; font-size:12px;">
                @(IncomePct > 10 ? Math.Round(IncomePct) + "%" : "")
            </div>
            <div style="width:@(ExpensePct)%; background-color:#e74c3c; display:flex; align-items:center; justify-content:center; color:white; font-weight:bold; font-size:12px;">
                @(ExpensePct > 10 ? Math.Round(ExpensePct) + "%" : "")
            </div>
        }
        else
        {
            <div style="width:100%; text-align:center; color:gray; line-height:30px;">No Data</div>
        }
    </div>

    <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:20px;">
        <span style="color:#2ecc71;">+@CurrentIncome.ToString("N0")</span>
        <span style="color:#e74c3c;">-@Math.Abs(CurrentExpense).ToString("N0")</span>
    </div>

    <div style="display:flex; gap:10px; margin-bottom:20px;">
        <button style="flex:1; padding:10px; border:none; border-radius:8px; font-weight:bold; cursor:pointer; background-color:@(isExpense ? "#333" : "#2ecc71"); color:@(isExpense ? "white" : "black");" @onclick="() => isExpense = false" aria-label="Show income category chart">Income</button>
        <button style="flex:1; padding:10px; border:none; border-radius:8px; font-weight:bold; cursor:pointer; background-color:@(isExpense ? "#e74c3c" : "#333"); color:white;" @onclick="() => isExpense = true" aria-label="Show expense category chart">Expense</button>
    </div>

    @if (ChartData.Any())
    {
        @foreach (var item in ChartData)
        {
            <div style="margin-bottom: 15px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span style="font-weight:bold;">@item.Name</span>
                    <span style="color:gray;">@item.AmountStr</span>
                </div>
                <div style="width:100%; background:#333; height:10px; border-radius:5px;">
                    <div style="width:@((int)(item.Pct * 100))%; background-color:@item.Color; height:100%; border-radius:5px;"></div>
                </div>
            </div>
        }
    }

    <div style="margin-top:30px; border-top: 1px solid #333; padding-top: 10px;">
        <h4 style="margin-bottom:10px; color:#ddd;">History</h4>
        @if (FilteredHistory.Any())
        {
            @foreach (var t in FilteredHistory)
            {
                <div style="background:#1f1f1f; padding:10px; border-bottom:1px solid #333; display:flex; justify-content:space-between; color:white;">
                    <div style="display:flex; flex-direction:column;">
                        <span>@t.Desc</span>
                        <small style="color:gray;">@t.Date.ToString("dd MMM yyyy") • @t.Category</small>
                    </div>
                    <span style="color:@t.ColorHex">@t.AmountDisplay</span>
                </div>
            }
        }
        else
        {
            <p style="color:gray;">No transactions found.</p>
        }
    </div>
</div>

@code {
    AppData myData = new AppData();
    bool isExpense = true;
    bool isLifetime = false;

    // Default value as string to avoid binding errors
    string selectedMonthStr = DateTime.Now.ToString("yyyy-MM");

    protected override async Task OnInitializedAsync()
    {
        myData = await Firebase.Load();
    }

    bool IsInFilter(DateTime date)
    {
        if (isLifetime) return true;

        if (!string.IsNullOrEmpty(selectedMonthStr) && DateTime.TryParse(selectedMonthStr + "-01", out DateTime selectedDate))
        {
            return date.Year == selectedDate.Year && date.Month == selectedDate.Month;
        }
        return false;
    }

    decimal CurrentIncome => myData.History.Where(x => IsInFilter(x.Date) && (x.AmountDisplay ?? "").StartsWith("+")).Sum(x => x.Amount);
    decimal CurrentExpense => myData.History.Where(x => IsInFilter(x.Date) && (x.AmountDisplay ?? "").StartsWith("-")).Sum(x => x.Amount);
    decimal TotalVolume => CurrentIncome + Math.Abs(CurrentExpense);
    decimal NetAmount => CurrentIncome - Math.Abs(CurrentExpense);

    decimal PrevMonthNet
    {
        get
        {
            if (isLifetime) return 0;
            if (!DateTime.TryParse(selectedMonthStr + "-01", out DateTime selectedDate)) return 0;
            var prev = selectedDate.AddMonths(-1);
            var prevIncome = myData.History.Where(x => x.Date.Year == prev.Year && x.Date.Month == prev.Month && (x.AmountDisplay ?? "").StartsWith("+")).Sum(x => x.Amount);
            var prevExpense = myData.History.Where(x => x.Date.Year == prev.Year && x.Date.Month == prev.Month && (x.AmountDisplay ?? "").StartsWith("-")).Sum(x => x.Amount);
            return prevIncome - Math.Abs(prevExpense);
        }
    }

    decimal MoMDelta => isLifetime ? 0 : NetAmount - PrevMonthNet;

    double IncomePct => TotalVolume == 0 ? 0 : (double)(CurrentIncome / TotalVolume) * 100;
    double ExpensePct => TotalVolume == 0 ? 0 : (double)(Math.Abs(CurrentExpense) / TotalVolume) * 100;

    List<Transaction> FilteredHistory => myData.History.Where(x => IsInFilter(x.Date)).OrderByDescending(x => x.Date).ToList();

    List<ChartItem> ChartData
    {
        get
        {
            var filtered = myData.History.Where(x => IsInFilter(x.Date) && (isExpense ? (x.AmountDisplay ?? "").StartsWith("-") : (x.AmountDisplay ?? "").StartsWith("+"))).ToList();

            double total = filtered.Sum(x => (double)x.Amount);
            if (total == 0) return new List<ChartItem>();

            return filtered.GroupBy(x => x.Category ?? "Other").Select(g =>
            {
                double val = g.Sum(x => (double)x.Amount);
                return new ChartItem { Name = g.Key, AmountStr = val.ToString("N2"), Pct = val / total, Color = isExpense ? "#e74c3c" : "#2ecc71" };
            }).OrderByDescending(x => x.Pct).ToList();
        }
    }
}