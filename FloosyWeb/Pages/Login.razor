@page "/"
@inject FirebaseService Firebase
@inject NavigationManager Nav
@inject IJSRuntime JS
@using Blazored.LocalStorage
@inject ISyncLocalStorageService LocalStorage

<div class="login-container">
    <div style="text-align:center; margin-bottom:30px;">
        <img src="images/appicon.png" style="width:100px; height:100px; border-radius:20px; box-shadow: 0 4px 15px rgba(0,230,118,0.3);" />
        <h1 style="color:#00E676; margin-top:10px; font-weight:bold;">Floosy</h1>
    </div>

    @if (mode == 0)
    {
        <h3 style="color:white; margin-bottom:20px;">Welcome Back!</h3>
        <input @bind="email" placeholder="Email" class="input-dark" />
        <input @bind="password" type="password" placeholder="Password" class="input-dark" />

        <div style="display:flex; align-items:center; gap:10px; margin-bottom:20px; color:#ccc; cursor:pointer;" @onclick="() => rememberMe = !rememberMe">
            <input type="checkbox" @bind="rememberMe" style="width:20px; height:20px; cursor:pointer; accent-color:#00E676;" />
            <span style="font-size:14px; user-select:none;">Remember Me</span>
        </div>

        <button class="btn-primary" @onclick="DoLogin">Login</button>

        <div style="margin-top:20px; display:flex; justify-content:space-between;">
            <button class="btn-link" @onclick="() => mode = 1">Create Account</button>
            <button class="btn-link" @onclick="() => mode = 2">Forgot Password?</button>
        </div>
    }
    else if (mode == 1) // REGISTER
    {
        <h3 style="color:white; margin-bottom:20px;">New Account</h3>
        <input @bind="newName" placeholder="Full Name" class="input-dark" />
        <input @bind="email" placeholder="Email" class="input-dark" />
        <input @bind="password" type="password" placeholder="Password" class="input-dark" />
        <button class="btn-primary" @onclick="DoRegister">Sign Up</button>
        <button class="btn-link" style="width:100%; margin-top:10px;" @onclick="() => mode = 0">Back to Login</button>
    }
    else if (mode == 2) // RESET
    {
        <h3 style="color:white; margin-bottom:20px;">Reset Password</h3>
        <input @bind="email" placeholder="Email" class="input-dark" />
        <button class="btn-primary" @onclick="DoReset">Send Link</button>
        <button class="btn-link" style="width:100%; margin-top:10px;" @onclick="() => mode = 0">Back to Login</button>
    }
</div>

<style>
    .login-container {
        padding: 30px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        min-height: 100vh;
        max-width: 400px;
        margin: 0 auto;
    }

    .input-dark {
        width: 100%;
        background: #333;
        color: white;
        border: 1px solid #444;
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 15px;
        font-size: 16px;
        outline: none;
        transition: 0.3s;
        box-sizing: border-box;
    }

        .input-dark:focus {
            border-color: #00E676;
        }

    .btn-primary {
        width: 100%;
        background: linear-gradient(45deg, #00E676, #00b359);
        color: black;
        border: none;
        padding: 15px;
        border-radius: 12px;
        font-weight: bold;
        font-size: 16px;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(0,230,118,0.2);
    }

    .btn-link {
        background: none;
        border: none;
        color: #aaa;
        cursor: pointer;
        font-size: 14px;
        text-decoration: underline;
    }
</style>

@code {
    int mode = 0;
    string email = "", password = "", newName = "";
    bool rememberMe = false;

    // 🔥 Added Check for Saved User
    protected override void OnInitialized()
    {
        var savedEmail = LocalStorage.GetItem<string>("SavedEmail");
        var savedPass = LocalStorage.GetItem<string>("SavedPass");
        if (!string.IsNullOrEmpty(savedEmail) && !string.IsNullOrEmpty(savedPass))
        {
            email = savedEmail;
            password = savedPass;
            rememberMe = true;
        }
    }

    async Task DoLogin()
    {
        if (string.IsNullOrEmpty(email) || string.IsNullOrEmpty(password)) return;
        var res = await Firebase.Login(email, password);
        if (res == "Success")
        {
            if (rememberMe) { LocalStorage.SetItem("SavedEmail", email); LocalStorage.SetItem("SavedPass", password); }
            else { LocalStorage.RemoveItem("SavedEmail"); LocalStorage.RemoveItem("SavedPass"); }
            Nav.NavigateTo("home");
        }
        else await JS.InvokeVoidAsync("alert", res);
    }

    async Task DoRegister()
    {
        if (string.IsNullOrEmpty(email) || string.IsNullOrEmpty(password) || string.IsNullOrEmpty(newName)) return;
        var res = await Firebase.Register(newName, email, password);
        if (res == "Success") Nav.NavigateTo("home");
        else await JS.InvokeVoidAsync("alert", res);
    }

    async Task DoReset()
    {
        if (string.IsNullOrEmpty(email)) return;
        var res = await Firebase.ResetPassword(email);
        await JS.InvokeVoidAsync("alert", res == "Success" ? "Check your email!" : res);
        if (res == "Success") mode = 0;
    }
}