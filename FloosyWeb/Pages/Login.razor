@page "/"
@inject FirebaseService Firebase
@inject NavigationManager Nav
@inject IJSRuntime JS
@using Blazored.LocalStorage
@inject ISyncLocalStorageService LocalStorage

<div class="login-container page-section">
    <div class="login-brand" style="text-align:center; margin-bottom:30px;">
        <img src="images/appicon.png" style="width:100px; height:100px; border-radius:20px; box-shadow: 0 4px 15px rgba(0,230,118,0.3);" />
        <h1 style="color:#00E676; margin-top:10px; font-weight:bold;">Floosy</h1>
    </div>

    @if (mode == 0)
    {
        <h3 style="color:white; margin-bottom:20px;">Welcome Back!</h3>
        <input @bind="email" placeholder="Email" class="input-dark" aria-label="Email" />

        <input @bind="password" type="@(showPassword ? "text" : "password")" placeholder="Password" class="input-dark" aria-label="Password" />

        <!-- ðŸ”’ SECURITY FIX: Remember Me now only saves email, NOT password -->
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:20px; color:#ccc; cursor:pointer;" @onclick="() => rememberMe = !rememberMe">
            <input type="checkbox" @bind="rememberMe" style="width:20px; height:20px; cursor:pointer; accent-color:#00E676;" aria-label="Remember email" />
            <span style="font-size:14px; user-select:none;">Remember Email</span>
        </div>

        <div style="display:flex; align-items:center; gap:10px; margin-bottom:20px; color:#ccc; cursor:pointer;" @onclick="() => showPassword = !showPassword">
            <input type="checkbox" @bind="showPassword" style="width:20px; height:20px; cursor:pointer; accent-color:#00E676;" aria-label="Show password" />
            <span style="font-size:14px; user-select:none;">Show Password</span>
        </div>

        <button class="btn-primary" @onclick="DoLogin">Login</button>

        @if (canUseBiometric)
        {
            <button class="btn-primary" style="margin-top:10px; background:#333; color:white; box-shadow:none;" @onclick="LoginWithBiometric">
                Login with Biometric
            </button>
        }

        <div style="display:flex; justify-content:space-between; margin-top:15px;">
            <button class="btn-link" @onclick="() => mode = 1" aria-label="Create account">Create Account</button>
            <button class="btn-link" @onclick="() => mode = 2" aria-label="Reset password">Forgot Password?</button>
        </div>
    }
    else if (mode == 1)
    {
        <h3 style="color:white; margin-bottom:20px;">Create Account</h3>
        <input @bind="newName" placeholder="Full Name" class="input-dark" aria-label="Full name" />
        <input @bind="email" placeholder="Email" class="input-dark" aria-label="Email" />

        <input @bind="password" type="@(showPassword ? "text" : "password")" placeholder="Password (min 6 characters)" class="input-dark" aria-label="Password" />

        <button class="btn-primary" @onclick="DoRegister">Sign Up</button>
        <button class="btn-link" style="width:100%; margin-top:10px;" @onclick="() => mode = 0">Back to Login</button>
    }
    else if (mode == 2)
    {
        <h3 style="color:white; margin-bottom:20px;">Reset Password</h3>
        <input @bind="email" placeholder="Email" class="input-dark" aria-label="Email" />
        <button class="btn-primary" @onclick="DoReset">Send Link</button>
        <button class="btn-link" style="width:100%; margin-top:10px;" @onclick="() => mode = 0">Back to Login</button>
    }
</div>

@if (isMessageVisible)
{
    <div class="modal-backdrop">
        <div class="modal-content" style="text-align:center;">
            <h3 style="margin-top:0; color:@(messageType == "Success" ? "#00E676" : "#e74c3c");">@messageTitle</h3>
            <p style="color:#ccc; margin-bottom:20px; font-size:14px;">@messageBody</p>
            <button class="btn-primary" style="padding:10px;" @onclick="() => isMessageVisible = false">OK</button>
        </div>
    </div>
}

<style>
    .login-container {
        display: flex;
        flex-direction: column;
        justify-content: center;
        min-height: 100vh;
        max-width: 420px;
        margin: 0 auto;
    }

    .login-brand {
        margin-top: -20px;
    }

    .input-dark {
        width: 100%;
        padding: 14px;
        margin-bottom: 15px;
        background-color: #1f1f1f;
        border: 1px solid #333;
        border-radius: 10px;
        color: white;
        font-size: 14px;
        box-sizing: border-box;
    }

        .input-dark::placeholder {
            color: #777;
        }

        .input-dark:focus {
            outline: none;
            border-color: #00E676;
            box-shadow: 0 0 5px rgba(0, 230, 118, 0.3);
        }

    .btn-primary {
        width: 100%;
        padding: 14px;
        background-color: #00E676;
        border: none;
        border-radius: 10px;
        color: black;
        font-weight: bold;
        font-size: 15px;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 3px 10px rgba(0, 230, 118, 0.3);
    }

        .btn-primary:hover {
            background-color: #00d168;
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(0, 230, 118, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

    .btn-link {
        background: none;
        border: none;
        color: #aaa;
        cursor: pointer;
        font-size: 14px;
        text-decoration: underline;
        width: auto;
        min-height: 40px;
        padding: 6px 0;
    }

    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 2000;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .modal-content {
        width: 85%;
        max-width: 300px;
        background: #1f1f1f;
        padding: 25px 20px;
        border-radius: 15px;
        border: 1px solid #333;
        box-shadow: 0 4px 15px rgba(0,0,0,0.5);
    }
</style>

@code {
    int mode = 0;
    string email = "", password = "", newName = "";
    bool rememberMe = false;
    bool showPassword = false;

    bool isMessageVisible = false;
    string messageTitle = "", messageBody = "", messageType = "Error";

    bool canUseBiometric = false;

    void ShowMessage(string title, string body, string type = "Error")
    {
        messageTitle = title; messageBody = body; messageType = type; isMessageVisible = true;
    }

    protected override async Task OnInitializedAsync()
    {
        // ðŸ”’ SECURITY FIX: Only load saved email, NOT password
        var savedEmail = LocalStorage.GetItem<string>("SavedEmail");
        if (!string.IsNullOrEmpty(savedEmail))
        {
            email = savedEmail;
            rememberMe = true;
        }

        // Clean up old password storage if it exists
        try
        {
            LocalStorage.RemoveItem("SavedPass");
        }
        catch { }

        // Check if this device even supports biometrics (WebAuthn)
        try
        {
            canUseBiometric = await JS.InvokeAsync<bool>("floosyBiometric.isSupported");
        }
        catch
        {
            canUseBiometric = false;
        }
    }

    async Task DoLogin()
    {
        if (string.IsNullOrEmpty(email) || string.IsNullOrEmpty(password))
        {
            ShowMessage("Missing Info", "Please enter email and password.", "Error");
            return;
        }

        var res = await Firebase.Login(email, password);
        if (res == "Success")
        {
            // ðŸ”’ SECURITY FIX: Only save email if "Remember Me" is checked
            // NEVER save the password in LocalStorage!
            if (rememberMe)
            {
                LocalStorage.SetItem("SavedEmail", email);
            }
            else
            {
                LocalStorage.RemoveItem("SavedEmail");
            }

            // Optional biometric unlock on supported devices:
            // Always store latest credentials locally (if supported),
            // so biometric login can re-use them later.
            try
            {
                var bioSupported = await JS.InvokeAsync<bool>("floosyBiometric.isSupported");
                if (bioSupported)
                {
                    // Store credentials for future biometric login (option 1 trade-off)
                    await JS.InvokeVoidAsync("floosyBiometric.setCredentials", email, password);
                }
            }
            catch { }

            Nav.NavigateTo("home");
        }
        else
        {
            ShowMessage("Login Failed", res, "Error");
        }
    }

    async Task DoRegister()
    {
        if (string.IsNullOrEmpty(email) || string.IsNullOrEmpty(password) || string.IsNullOrEmpty(newName))
        {
            ShowMessage("Missing Info", "Please fill in all fields.", "Error");
            return;
        }

        if (!IsValidEmail(email))
        {
            ShowMessage("Invalid Email", "Please enter a valid email like name@gmail.com or name@outlook.com.", "Error");
            return;
        }

        if (password.Length < 6)
        {
            ShowMessage("Weak Password", "Password must be at least 6 characters.", "Error");
            return;
        }

        var res = await Firebase.Register(newName, email, password);
        if (res == "Success")
        {
            Nav.NavigateTo("home");
        }
        else
        {
            ShowMessage("Registration Failed", res, "Error");
        }
    }

    bool IsValidEmail(string value)
    {
        if (string.IsNullOrWhiteSpace(value)) return false;

        var atIndex = value.IndexOf('@');
        if (atIndex <= 0 || atIndex != value.LastIndexOf('@')) return false;

        var localPart = value[..atIndex];
        var domainPart = value[(atIndex + 1)..];

        if (localPart.Length < 2 || domainPart.Length < 3) return false;
        if (!domainPart.Contains('.')) return false;

        var lower = value.ToLowerInvariant();

        // Allow any real-looking domain, but block very obvious test values
        if (lower == "test@test" || lower.StartsWith("test@") || lower.EndsWith("@test.com"))
            return false;

        return true;
    }

    class BioCreds
    {
        public string e { get; set; } = "";
        public string p { get; set; } = "";
    }

    async Task LoginWithBiometric()
    {
        try
        {
            var supported = await JS.InvokeAsync<bool>("floosyBiometric.isSupported");
            if (!supported)
            {
                ShowMessage("Not Supported", "Biometric login is not available on this device.", "Error");
                return;
            }

            var enabled = await JS.InvokeAsync<bool>("floosyBiometric.isEnabled");
            if (!enabled)
            {
                ShowMessage("Not Enabled", "Go to Settings â†’ Security and enable biometric unlock on this device first.", "Error");
                return;
            }

            var ok = await JS.InvokeAsync<bool>("floosyBiometric.verify");
            if (!ok)
            {
                ShowMessage("Cancelled", "Biometric login was cancelled or failed.", "Error");
                return;
            }

            // Get saved credentials
            var creds = await JS.InvokeAsync<BioCreds>("floosyBiometric.getCredentials");
            if (creds == null || string.IsNullOrWhiteSpace(creds.e) || string.IsNullOrWhiteSpace(creds.p))
            {
                ShowMessage("Login Required", "Please login once with email & password after enabling biometric, so we can store credentials for biometric login.", "Error");
                return;
            }

            // Perform real Firebase login using stored credentials
            var res = await Firebase.Login(creds.e, creds.p);
            if (res != "Success")
            {
                ShowMessage("Login Failed", "Stored credentials are no longer valid. Please login again with email & password.", "Error");
                return;
            }

            // Update email field / remember-me behavior
            email = creds.e;
            if (rememberMe)
            {
                LocalStorage.SetItem("SavedEmail", email);
            }

            Nav.NavigateTo("home");
        }
        catch
        {
            ShowMessage("Error", "Biometric login is not available right now.", "Error");
        }
    }

    async Task DoReset()
    {
        if (string.IsNullOrEmpty(email))
        {
            ShowMessage("Missing Email", "Enter email first.", "Error");
            return;
        }

        var res = await Firebase.ResetPassword(email);
        if (res == "Success")
        {
            ShowMessage("Email Sent", "Check your inbox for reset link!", "Success");
            mode = 0;
        }
        else
        {
            ShowMessage("Error", res, "Error");
        }
    }
}
